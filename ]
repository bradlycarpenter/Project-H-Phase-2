extends CharacterBody2D

@export var speed = 300
@onready var animation_tree : AnimationTree = $AnimationTree

var input_direction : Vector2 = Vector2.ZERO
var iso_direction : Vector2 = Vector2.ZERO
const y_direction = 0.6
const x_direction = 0.9
const y_diagonal_direction = 0.353553
const x_diagonal_direction = y_diagonal_direction*2

func _ready():
	animation_tree.active = true

func _physics_process(delta):
	update_direction(delta)
	update_animation_parameters()
	move_and_slide() # okay we actually need for collisions it FUCK

func update_direction(delta):
	iso_direction = Vector2.ZERO

	if (get_input_direction() != Vector2.ZERO):
		if (Input.is_action_pressed("move_up")):
			if (Input.is_action_pressed("move_right")):
				iso_direction.y += -y_diagonal_direction
				iso_direction.x += x_diagonal_direction
			elif (Input.is_action_pressed("move_left")):
				iso_direction.y += -y_diagonal_direction
				iso_direction.x += -0.707107
			else:
				iso_direction.y += -y_direction

		elif (Input.is_action_pressed("move_down")):
			if (Input.is_action_pressed("move_right")):
				iso_direction.y += 0.353553
				iso_direction.x += 0.707107
			elif (Input.is_action_pressed("move_left")):
				iso_direction.y += 0.353553
				iso_direction.x += -0.707107
			else:
				iso_direction.y += y_direction

		elif (Input.is_action_pressed("move_right")):
			iso_direction.x += x_direction

		elif (Input.is_action_pressed("move_left")):
			iso_direction.x += -x_direction

	velocity = iso_direction * speed * delta * 100

func get_input_direction():
	input_direction = Input.get_vector(
	"move_left", 
	"move_right", 
	"move_up", 
	"move_down"
	).normalized()
	return input_direction

func update_animation_parameters():
	if (get_input_direction() == Vector2.ZERO):
		animation_tree["parameters/conditions/is_idling"] = true
		animation_tree["parameters/conditions/is_running"] = false

	else:
		animation_tree["parameters/conditions/is_idling"] = false
		animation_tree["parameters/conditions/is_running"] = true
	
	if (get_input_direction() != Vector2.ZERO): # so it stays facing last moved direction
		animation_tree["parameters/IDLE/blend_position"] = input_direction
		animation_tree["parameters/RUN/blend_position"] = input_direction
